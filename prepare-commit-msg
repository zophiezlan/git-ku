#!/bin/sh
#
# Haikommit prepare-commit-msg hook
# Generates a haiku commit message from staged changes
#

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only run for regular commits (not merge, squash, etc.)
if [ -z "$COMMIT_SOURCE" ] || [ "$COMMIT_SOURCE" = "message" ]; then
    # Check if there's already a message
    if [ ! -s "$COMMIT_MSG_FILE" ] || ! grep -q "^[^#]" "$COMMIT_MSG_FILE"; then
        # Find the haikommit.py script
        # First try relative to this hook
        HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
        
        if [ -f "$HOOK_DIR/../../haikommit.py" ]; then
            SCRIPT="$HOOK_DIR/../../haikommit.py"
        elif [ -f "$HOOK_DIR/../haikommit.py" ]; then
            SCRIPT="$HOOK_DIR/../haikommit.py"
        elif command -v haikommit.py >/dev/null 2>&1; then
            SCRIPT="haikommit.py"
        else
            # Can't find the script, just exit silently
            exit 0
        fi
        
        # Generate the haiku
        HAIKU=$(python3 "$SCRIPT" 2>/dev/null)
        
        if [ $? -eq 0 ] && [ -n "$HAIKU" ]; then
            # Prepend the haiku to the commit message file
            TEMP_FILE=$(mktemp)
            echo "$HAIKU" > "$TEMP_FILE"
            echo "" >> "$TEMP_FILE"
            cat "$COMMIT_MSG_FILE" >> "$TEMP_FILE"
            mv "$TEMP_FILE" "$COMMIT_MSG_FILE"
        fi
    fi
fi

exit 0
